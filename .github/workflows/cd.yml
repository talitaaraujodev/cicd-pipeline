name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Pull Docker image
        run: sudo docker pull talitasantosdev/cicd-pipeline:latest

      - name: Stop and remove old Docker containers
        run: |
          if [ "$(sudo docker ps -a -q -f name=cicd-pipeline-container-new)" ]; then
            sudo docker stop cicd-pipeline-container-new
            sudo docker rm cicd-pipeline-container-new
          fi
          if [ "$(sudo docker ps -a -q -f name=cicd-pipeline-container)" ]; then
            sudo docker stop cicd-pipeline-container
            sudo docker rm cicd-pipeline-container
          fi

      - name: Run new Docker container
        run: |
          sudo docker run -d -p 5000:5000 --name cicd-pipeline-container talitasantosdev/cicd-pipeline:latest
          sudo docker run -d -p 5001:5000 --name cicd-pipeline-container-new talitasantosdev/cicd-pipeline:latest

      - name: Wait for new containers to be healthy
        run: sleep 30  # Adjust the sleep duration as needed

      - name: Update load balancer to point to the new container
        run: |
          # Update the Nginx configuration to point to the new container
          sudo sed -i 's/5000/5001/' /etc/nginx/conf.d/default.conf
          sudo nginx -s reload
