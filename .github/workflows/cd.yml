name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Pull Docker image
        run: sudo docker pull talitasantosdev/cicd-pipeline:latest

      - name: Stop and remove old Docker containers
        run: |
          if [ "$(sudo docker ps -a -q -f name=cicd-pipeline-container-new)" ]; then
            sudo docker stop cicd-pipeline-container-new
            sudo docker rm cicd-pipeline-container-new
          fi
          if [ "$(sudo docker ps -a -q -f name=cicd-pipeline-container)" ]; then
            sudo docker stop cicd-pipeline-container
            sudo docker rm cicd-pipeline-container
          fi

      - name: Ensure port 5001 is free
        run: |
          if lsof -i:5001; then
            sudo kill -9 $(lsof -t -i:5001)
          fi

      - name: Run new Docker container
        run: |
          sudo docker run -d -p 5001:5000 --name cicd-pipeline-container-new talitasantosdev/cicd-pipeline:latest

      - name: Wait for new container to be healthy
        run: sleep 30  # Adjust the sleep duration as needed

      - name: Update load balancer to point to the new container
        run: |
          sudo sed -i 's/5000/5001/' /etc/nginx/conf.d/default.conf
          sudo nginx -s reload

      - name: Remove old Docker container
        run: |
          if [ "$(sudo docker ps -a -q -f name=cicd-pipeline-container)" ]; then
            sudo docker rm -f cicd-pipeline-container
          fi

      - name: Rename new container to the old container name (optional)
        run: sudo docker rename cicd-pipeline-container-new cicd-pipeline-container
